timeout: "1200s"

options:
  substitutionOption: "ALLOW_LOOSE"

substitutions:
  _DEPLOY_REGION: "europe-west1"
  _AR_HOSTNAME: "europe-west1-docker.pkg.dev"
  _AR_REPOSITORY: "cloud-run-source-deploy"
  _SERVICE_NAME: "orbi-city-website"
  _IMAGE_NAME: "orbi-city-website"

steps:
  - id: "Build & Push"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - "-ceu"
      - |
        set -o pipefail
        TAG="${SHORT_SHA:-${BUILD_ID}}"
        IMAGE="${_AR_HOSTNAME}/${PROJECT_ID}/${_AR_REPOSITORY}/${_IMAGE_NAME}:${BUILD_ID}"
        echo "Building $$IMAGE"
        docker build -t "$$IMAGE" -f Dockerfile .
        docker push "$$IMAGE"
        echo -n "$$IMAGE" > /workspace/image.txt

  - id: "Deploy"
    name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-ceu"
      - |
        set -o pipefail
        IMAGE="$(cat /workspace/image.txt)"
        echo "Deploying $$IMAGE to ${_DEPLOY_REGION}"
        gcloud run deploy "${_SERVICE_NAME}" \
          --image="$$IMAGE" \
          --region="${_DEPLOY_REGION}" \
          --platform=managed \
          --allow-unauthenticated \
          --set-env-vars=NODE_ENV=production
